var photos=[],thumbs=[],images=[],count_photos=0,count_updates=0,can_fave=0,idx=0;
function cwf_init(a){photos=a;count_photos=photos.length;cwf_init_layout();cwf_init_shortcuts();a=location.hash;var b=null;if(a)a=parseInt(a.substring(1,a.length));for(var c=0;c<count_photos;c++){thumbs.push(photos[c][6]);images.push(photos[c][7]);if(a&&!b&&photos[c][0]==a)b=c}if(b)idx=b;$.backstretch(thumbs[idx]);$({}).imageLoader({images:thumbs,async:true});$({}).imageLoader({images:[images.shift()],async:false,complete:function(){cwf_show_photo(idx)}});a=parseInt(new Date/1E3);cwf_schedule_check_photos(a)}
function cwf_init_subscription(){var a=function(b){b=JSON.parse(b);b=b.photos;var c=b.length;if(c){for(var d=[],e=0;e<c;e++){var f=b[e];d.push([f.photo_id,f.title,f.owner,f.ownername,f.faved_by_nsid,f.faved_by,f.thumb_url,f.display_url])}cwf_init(d)}else{b=new Date;b=String(b);b="Last checked at "+b+", still nothing yet.";$("#last_check").html(b);cwf_init_subscription(6E4)}};setTimeout(function(){$.ajax({url:"/api",data:{method:"flickr.photos.friends.faves"},success:a})},6E4)}
function cwf_init_layout(){$("#content").hide();$("#main").css("background-color","transparent");$("#footer").css("opacity",".75");$("#main").append('<div id="cwf_about"></div>')}
function cwf_init_shortcuts(){var a=false,b=null,c=function(g){g||(g=2E4);b=setTimeout(function(){cwf_show_next_photo("overflow");c()},g)},d=function(){cwf_show_previous_photo("overflow")},e=function(){cwf_show_next_photo("overflow")},f=function(){cwf_show_photo(0)},h=function(){cwf_show_photo(photos.length-1)};$(document).keydown(function(g){if(g.keyCode==37)d();else if(g.keyCode==38)f();else if(g.keyCode==39)e();else if(g.keyCode==40)h();else if(g.keyCode==65)(a=a?0:1)?c(1E3):clearTimeout(b);else g.keyCode==
80&&cwf_toggle_pixel_mode(g.shiftKey)});$(document).touchwipe({wipeLeft:e,wipeRight:d,wipeUp:f,wipeDown:h,min_move_x:20,min_move_y:20,preventDefaultEvents:true})}function cwf_schedule_check_photos(a){setTimeout(function(){$.ajax({url:"/api",data:{method:"flickr.photos.friends.faves",older_than:a},success:cwf_check_photos_callback,error:function(b){console.log(b);cwf_schedule_check_photos(a)}})},6E4)}
function cwf_check_photos_callback(a){try{_cwf_check_photos_callback(a)}catch(b){console.log(b);console.log(a)}last_check=parseInt(new Date/1E3);cwf_schedule_check_photos(last_check)}
function _cwf_check_photos_callback(a){a=JSON.parse(a);a=a.photos;var b=a.length;if(b){a.reverse();for(var c=[],d=0;d<b;d++){var e=a[d];c.push(e.display_url);c.push(e.thumb_url);photos.unshift([e.photo_id,e.title,e.owner,e.ownername,e.faved_by_nsid,e.faved_by,e.thumb_url,e.display_url])}$({}).imageLoader({images:c,async:true});idx+=b;count_updates+=b;a='<a href="#" onclick="cwf_show_photo(0);return false;">';a+=count_updates>1?"there are "+count_updates+" new faves":"there are new faves";a+="</a>";
$("#cwf_updates").html(a);$("#cwf_photo_idx").html(idx+1);$("#cwf_count_photos").html(photos.length)}}function cwf_next_photo(a){if(a)return idx<photos.length-1?idx+1:0;return idx<photos.length-1?idx+1:-1}function cwf_previous_photo(a){if(a)return idx>0?idx-1:count_photos-1;return idx>0?idx-1:-1}function cwf_show_previous_photo(a){a=cwf_previous_photo(a);cwf_show_photo(a)}function cwf_show_next_photo(a){a=cwf_next_photo(a);cwf_show_photo(a)}
function cwf_show_photo(a){count_updates=0;idx=a;for(var b=[],c=0;c<2;c++){if(!images.length)break;b.push(images.shift());b.push(images.unshift())}b.length&&$({}).imageLoader({images:b,async:true});var d=photos[a];b=d[0];c=d[1];var e=d[2],f=d[3],h=d[4],g=d[5],i=d[6],j=d[7];d=d[8];a=a+1;c=c+", by "+f;msg='<a href="http://www.flickr.com/photos/'+e+"/"+b+'/" target="_flickr" title="'+c+'">';msg+='<img src="'+j+'" /></a><br >';msg+='<div id="cwf_about_text">';msg+='<a href="http://www.flickr.com/photos/'+
h+'/faves/" target="_flickr">'+g+"</a>";msg+=" <span>"+symbols_faved+"</span>  ";msg+='<a href="http://www.flickr.com/photos/'+e+'/" target="_flickr">'+f+"</a><br />";msg+='no. <span id="cwf_photo_idx">'+a+'</span> of <span id="cwf_count_photos">'+photos.length+"</span> faves";if(a>1)msg+=' / <a href="#" onclick="cwf_show_next_photo();return false;" title="before, keyboard shortcut: \u21e6">before</a>';if(a<count_photos)msg+=' / <a href="#" onclick="cwf_show_previous_photo();return false;" title="after, keyboard short: \u21e8">after</a>';
msg+=" / "+photo_favorites_generate_html(b,d);msg+='<div id="cwf_updates"></div>';msg+="</div>";$("#cwf_about").html("");$.backstretch(i);$("#cwf_about").html(msg)}function cwf_toggle_pixel_mode(a){var b=$("#cwf_about"),c=$("#footer");if(b.css("display")=="none"){b.show();c.show();screenfull&&screenfull.exit()}else{b.hide();c.hide();a&&screenfull&&screenfull.request()}};
